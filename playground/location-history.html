---
layout: null
permalink: /beta/location-history
---

<!-- Version fd7cf27 -->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Location History</title>
    <style>#map{height:100%}body,html{height:100%;margin:0;padding:0}#floating-panel{display:flex;position:absolute;top:10px;left:35%;z-index:5;text-align:center}.group{border:1px solid #999;border-radius:3px;margin:5px;padding:5px;line-height:25px;background-color:white;font-family:'Roboto','sans-serif';font-size:small}#intensityNum,#opacityNum,#radiusNum{font-weight:800}</style>
  </head>
  <body>
    <div id="floating-panel">
      <div class="group">
        <div class="subject">Mode</div>
        <input type="radio" name="mapMode" onclick="updateMapMode()" value="fog">Fog</input>
        <input type="radio" name="mapMode" onclick="updateMapMode()" value="heatmap" checked>Heatmap</input>
      </div>

      <div class="group">
        <div class="subject">Radius <span id=radius>10</span></div>
        <button onclick="changeRadius(+2)">Up</button>
        <button onclick="changeRadius(-2)">Down</button>
      </div>

      <div class="group">
        <div class="subject">Sampling Rate <span id=samplingRate>5</span></div>
        <button onclick="changeSamplingRate(+4)">Up</button>
        <button onclick="changeSamplingRate(-4)">Down</button>
      </div>

      <div class="group">
        <div class="subject">Location Precision <span id=locationPrecision>4</span></div>
        <button onclick="changeLocationPrecision(+1)">Up</button>
        <button onclick="changeLocationPrecision(-1)">Down</button>
      </div>

      <div class="group">
          <div class="subject">Opacity <span id=opacity>0.8</span></div>
          <button onclick="changeOpacity(+0.1)">Up</button>
          <button onclick="changeOpacity(-0.1)">Down</button>
      </div>
    </div>
    <div id="map"></div>

    <script>
      var heatmap,locations,map,overlay,maxIntensity=200;var redrawOverlayListener,maxIntensityListener;var mapMode=document.querySelector('input[name="mapMode"]:checked').value;const queryParams=new URLSearchParams(window.location.search);[['radius',normalizedRadius],['samplingRate',normalizedSamplingRate],['locationPrecision',normalizedLocationPrecision],['opacity',normalizedOpacity]].forEach(configPair=>{const overriddenConfig=queryParams.get(configPair[0]);if(overriddenConfig!==null){document.getElementById(configPair[0]).innerText=configPair[1](overriddenConfig)}});var radius= +document.getElementById('radius').innerText;var samplingRate= +document.getElementById('samplingRate').innerText;var locationPrecision= +document.getElementById('locationPrecision').innerText;var opacity= +document.getElementById('opacity').innerText;function updateMaxIntensity(){const zoom=map.getZoom();if(zoom<=10){maxIntensity=200}else if(zoom<=12){maxIntensity=200-(zoom-10)*75}else if(zoom<=14){maxIntensity=50-(zoom-12)*20}else{maxIntensity=5}heatmap.set('maxIntensity',maxIntensity)}function redrawHeatmap(){if(heatmap){heatmap.setMap(null)}heatmap=new google.maps.visualization.HeatmapLayer({data:locations,maxIntensity:maxIntensity,radius:radius,opacity:opacity});heatmap.setMap(map)}function redrawOverlay(){if(overlay){overlay.setMap(null)}var canvas=document.createElement('canvas');canvas.width=1000;canvas.height=1000;var ctx=canvas.getContext('2d');ctx.globalAlpha=opacity;ctx.fillStyle='#000000CC';ctx.fillRect(0,0,1000,1000);var imageBounds={north:map.getBounds().getNorthEast().lat(),east:map.getBounds().getNorthEast().lng(),south:map.getBounds().getSouthWest().lat(),west:map.getBounds().getSouthWest().lng()};if(locations){ctx.globalCompositeOperation='destination-out';ctx.beginPath();locations.forEach(l=>{const centerX= -(l.lng()-imageBounds.west)/(imageBounds.west-imageBounds.east)*1000;const centerY= -(l.lat()-imageBounds.north)/(imageBounds.north-imageBounds.south)*1000;ctx.moveTo(centerX+radius,centerY);ctx.arc(centerX,centerY,radius,0,2*Math.PI,false)});ctx.fill()}overlay=new google.maps.GroundOverlay(canvas.toDataURL('image/png'),imageBounds);overlay.setMap(map)}function loadLocationsFromStaticData(){var uniqueLocations={};return fetch('static/location.json').then(response=>{return response.json().then(result=>{result.locations.forEach((entry,index,self)=>{const entryLoc=(entry.latitudeE7*10**-7).toFixed(locationPrecision)+(entry.longitudeE7*10**-7).toFixed(locationPrecision);if(!uniqueLocations[entryLoc]){uniqueLocations[entryLoc]=entry}})})}).then(()=>Object.values(uniqueLocations).filter((_,index)=>index%samplingRate===0)).then(sampledLocations=>{console.log(sampledLocations.length);locations=sampledLocations.map((entry)=>{return new google.maps.LatLng(entry.latitudeE7*(10**-7),entry.longitudeE7*(10**-7))})})}function initMap(){map=new google.maps.Map(document.getElementById('map'),{zoom:10,center:{lat:37.59,lng:-122.434},mapTypeId:'roadmap'});loadLocationsFromStaticData().then(()=>{switch(mapMode){case 'heatmap':redrawHeatmap();maxIntensityListener=map.addListener('idle',updateMaxIntensity);break;case 'fog':redrawOverlay();redrawOverlayListener=map.addListener('idle',redrawOverlay);break}})}function updateMapMode(){mapMode=document.querySelector('input[name="mapMode"]:checked').value;switch(mapMode){case 'heatmap':if(overlay){overlay.setMap(null)}google.maps.event.removeListener(redrawOverlayListener);redrawHeatmap();maxIntensityListener=map.addListener('idle',updateMaxIntensity);break;case 'fog':if(heatmap){heatmap.setMap(null)}google.maps.event.removeListener(maxIntensityListener);redrawOverlay();redrawOverlayListener=map.addListener('idle',redrawOverlay);break}}function normalizedRadius(newRadius){if(newRadius>=50){return 50}else if(newRadius<=4){return 4}else{return newRadius}}function changeRadius(step){const newRadius=radius+step;radius=normalizedRadius(newRadius);document.getElementById("radius").innerText=radius;switch(mapMode){case 'heatmap':heatmap.set('radius',radius);break;case 'fog':redrawOverlay();break}}function normalizedSamplingRate(newSamplingRate){if(newSamplingRate<=1){return 1}else{return newSamplingRate}}function changeSamplingRate(step){const newSamplingRate=samplingRate+step;samplingRate=normalizedSamplingRate(newSamplingRate);document.getElementById("samplingRate").innerText=samplingRate;loadLocationsFromStaticData().then(()=>{switch(mapMode){case 'heatmap':heatmap=new google.maps.visualization.HeatmapLayer({data:locations,map:map,maxIntensity:maxIntensity,radius:radius,opacity:opacity});break;case 'fog':redrawOverlay();break}})}function normalizedLocationPrecision(newLocationPrecision){if(newLocationPrecision<=1){return 1}else if(newLocationPrecision>=8){return 8}else{return newLocationPrecision}}function changeLocationPrecision(step){const newLocationPrecision=locationPrecision+step;locationPrecision=normalizedLocationPrecision(newLocationPrecision);document.getElementById("locationPrecision").innerText=locationPrecision;loadLocationsFromStaticData().then(()=>{switch(mapMode){case 'heatmap':heatmap=new google.maps.visualization.HeatmapLayer({data:locations,map:map,maxIntensity:maxIntensity,radius:radius,opacity:opacity});break;case 'fog':redrawOverlay();break}})}function normalizedOpacity(newOpacity){if(newOpacity<=0.1){return 0.1}else if(newOpacity>=1){return 1.0}else{return Math.round(newOpacity*10)/10}}function changeOpacity(step){const newOpacity=opacity+step;opacity=normalizedOpacity(newOpacity);document.getElementById("opacity").innerText=opacity;switch(mapMode){case 'heatmap':heatmap.set('opacity',opacity);break;case 'fog':redrawOverlay();break}}
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCXkVOhpZ2wf2b48FV8gG7UOPo4Cc3YHes&libraries=visualization&callback=initMap">
    </script>
  </body>
</html>
